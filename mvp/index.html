<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <link rel="stylesheet" href="main.css">
    <title>BMMN</title>

</head>

<body>
    <!-- charts -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="population.json.js"></script>
    <script src="geo_json_data.json.js"></script>
    <script src="choropleth.js"></script>
    <script src="d3-tip.js"></script>
    <script src="finCharts.js"></script>
    <script src="enrollment/enrollCharts.js"></script>
    <script src="enrollment/enroll_states_cleaned.csv.js"></script>
    <link rel="stylesheet" href="enrollment/enrollChart.css">
    <script src="achieveCharts.js"></script>

    <!-- data -->
    <script src="chartsData/G4G8TestScore.csv.js"></script>
    
    <!-- tooltip -->
    <div id="tooltip" class="hidden">
        <p><strong>State</strong></p>
        <p><span id="value">100</span>%</p>
    </div>

    <nav class="navbar navbar-dark fixed-top bg-primary flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">BMMN</a>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 bg-light d-none d-md-block sidebar">
                <div class="left-sidebar">
                    <ul class="nav flex-column sidebar-nav">
                        <!-- sidebar enrollment -->
                        <li class="nav-item active">
                            <a id="enroll" class="nav-link" href="#enroll">
                                <i class="fas fa-user-graduate mr-2"></i>
                                Enrollment
                            </a>
                        </li>

                        <!-- sidebar financial -->
                        <li class="nav-item">
                            <a id="fin" class="nav-link" href="#fin">
                                <i class="fas fa-money-check-alt mr-2"></i>
                                Financial
                            </a>
                        </li>

                        <!-- sidebar achievement -->
                        <li class="nav-item">
                            <a id="achieve" class="nav-link" href="#achieve">
                                <i class="fas fa-trophy mr-2"></i>
                                Achievement
                            </a>
                        </li>

                        <!-- sidebar extras -->
                        <li class="nav-item">
                            <a id="extra" class="nav-link" href="#extra">
                                <i class="fas fa-chart-line mr-2"></i>
                                Extras
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- main body -->
    <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
        <h3 style="margin-top: -80px;">BMMN Open Data Portal - US Education</h3>
        <hr>

        <!-- graphs -->
        <div class="map-graph">
            <svg id="choropleth" width="600" height="400"></svg>
        </div>

        <h3>Graphs</h3>
        <hr>
        <div class="row" id="row1">
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-body" id="card1">
                        <form id="achieve1-form" style="float:right; display:none"></form>
                        <h5 class="card-title">Graph 1</h5>
                        <select id="enroll-selectGrade"></select>
                        <svg id="Chart1" class="chart1" width="500" height="400"></svg>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-body" id="card2">
                        <h5 class="card-title">Graph 2</h5>
                        <select id="enroll-selectYear"></select>
                        <svg id="Chart2" class="chart1" width="500" height="400"></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="row2">
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-body" id="card3">
                        <h5 class="card-title">Graph 3</h5>
                        <select id="enroll-selectYearMale"></select>
                        <svg id="Chart3" class="chart1" width="500" height="400"></svg>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-body" id="card4">
                        <h5 class="card-title">Graph 4</h5>
                        <svg id="Chart4" class="chart1" width="500" height="400"></svg>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- script -->
    <script>
        var svgMap = d3.select("#choropleth");
        var svgFinChart1 = d3.select("#Chart1");
        var svgFinChart2 = d3.select("#Chart2");
        var svgFinChart3 = d3.select("#Chart3");
        var svgFinChart4 = d3.select("#Chart4");
        var svgEnrollChart1 = d3.select("#Chart1");
        var svgEnrollChart2 = d3.select("#Chart2");
        var svgEnrollChart3 = d3.select("#Chart3");
        var svgEnrollChart4 = d3.select("#Chart4");
        var svgAchieveChart1 = d3.select("#Chart1");
        var svgAchieveChart2 = d3.select("#Chart2");

        $(".nav-item").on('click', function() {
            $(".nav-item").removeClass('active');
            $(this).addClass('active');
        })


        // set default as enrollment
        var last_clicked = 'enroll';
        var state = 'Illinois';

        // draw charts based on state
        function vizMapper (state_passed){
            state = state_passed

            if(last_clicked=='fin'){
                FIN1.drawMap(svgFinChart1, state_passed);
                FIN2.drawMap(svgFinChart2, state_passed);
                FIN3.drawMap(svgFinChart3, state_passed);
                FIN4.drawMap(svgFinChart4, state_passed);

            } else if (last_clicked == 'enroll') {
                enrollmentData = getEnrollmentData(state_passed);
                ENR1.drawMap(svgEnrollChart1, enrollmentData, state_passed);
                ENR2.drawMap(svgEnrollChart2, enrollmentData, state_passed);
                ENR3.drawMap(svgEnrollChart3, enrollmentData, state_passed);

                
            } else if (last_clicked == 'achieve') {
                data = getTestScoreData(state);
                ACH1.drawLineChart(svgAchieveChart1, data, state);
                ACH2.drawBarChart(svgAchieveChart2, data, state);
            }

        };

        // Parse enrollment data 
        var enrollmentCSVData = d3.csvParse(enrollmentDataCSVText,
          function(d) {
              if (d.YEAR > 2009 && d.YEAR < 2016) {
                  d.YEAR = +d.YEAR;
              }
              d.G01_A_A = +d.G01_A_A;
              d.G02_A_A = +d.G02_A_A;
          return d;
          });

          function getEnrollmentData(selectedState) {
              // loop through data and check if state is the same as selected state
              
              var result = [];
              for (var i = 0; i < enrollmentCSVData.length; i++)  {
                  var stateFromData = enrollmentCSVData[i].STATE.replace(new RegExp("\_", "g"), " ")
                if (stateFromData == selectedState.toUpperCase()) {
                    result.push(enrollmentCSVData[i])
                } 
              }
              return result;
          }

          

        // read grade 4 and grade 8 test score data
        var G4G8ScoreData = d3.csvParse(G4G8ScoreCSVData,
                            function(d) {
                                d.STATE = d.STATE;
                                return d;
                            });
        

        function getTestScoreData(selectedState) {   
            var data = []
            for (var i = 0; i < G4G8ScoreData.length; i++) {
                var detail = G4G8ScoreData[i];
                var state = detail.STATE;
                state = state.replace(new RegExp("\_", "g"), " ");
                if (state == selectedState.toUpperCase()) {
                    data.push(detail)
                }
            }
            return data
        }

        // draw choropleth
        MAP = Map();
        MAP.drawMap(svgMap);
        ACH1 = LineChartVis();
        ACH2 = BarChartVis();

        // when state is selected, redraw charts
        MAP.dispatch.on(
            "selected",
            function(key) {
                vizMapper(key);
            } 
        );

        // select grade achievement
        ACH1.dispatch.on("change", function(selected) {
            var selectedGrade = 4;
            if (selected == "Grade 4") { grade = 4}
            else if (selected == "Grade 8") { grade = 8}
            ACH2.drawBarChart(svgAchieveChart2, data, state, grade, 2019);
            
        });

        $('#fin').on('click', function () {
            $('#achieve1-form').css("display", "none");
            $("#row1").css("display", "");
            $("#row2").css("display", "");
            $("#enroll-selectYearMale").css("display", "none");
            $("#enroll-selectYear").css("display", "none");
            $("#enroll-selectGrade").css("display", "none");
            $("#card4").css("display", "");
            last_clicked = 'fin';

            FIN1 = finMap1();
            FIN1.drawMap(svgFinChart1, state);

            FIN2 = finMap2();
            FIN2.drawMap(svgFinChart2, state);

            FIN3 = finMap3();
            FIN3.drawMap(svgFinChart3, state);

            FIN4 = finMap4();
            FIN4.drawMap(svgFinChart4, state);

        })

        $('#enroll').on('click', function () {
            $('#achieve1-form').css("display", "none");
            $("#row1").css("display", "");
            $("#row2").css("display", "");
            $("#enroll-selectYearMale").css("display", "");
            $("#enroll-selectYear").css("display", "");
            $("#enroll-selectGrade").css("display", "");
            $("#card4").css("display", "none");

            last_clicked = 'enroll';

            // get enrollment a list data based on state
            enrollmentData = getEnrollmentData(state);

            ENR1 = enrollMap1();
            ENR1.drawMap(svgEnrollChart1, enrollmentData, state);

            ENR2 = enrollMap2();
            ENR2.drawMap(svgEnrollChart2, enrollmentData, state);

            ENR3 = enrollMap3();
            ENR3.drawMap(svgEnrollChart3, enrollmentData, state);

            // ENR4 = enrollMap4();
            // ENR4.drawMap(svgEnrollChart4);

        })

        $('#achieve').on('click', function () {
            $('#achieve1-form').css("display", "");
            $("#row1").css("display", "");
            $("#row2").css("display", "none");
            $("#enroll-selectYearMale").css("display", "none");
            $("#enroll-selectYear").css("display", "none");
            $("#enroll-selectGrade").css("display", "none");
            $("#card4").css("display", "none");
            
            last_clicked = 'achieve'
            data = getTestScoreData(state);
            ACH1.drawLineChart(svgAchieveChart1, data, state);
            ACH2.drawBarChart(svgAchieveChart2, data, state);

        })

        $('#extra').on('click', function () {
            // $('#achieve1-form').css("display", "none");
            $("#row1").css("display", "none");
            $("#row2").css("display", "none");
            // $("#enroll-selectYearMale").css("display", "none");
            // $("#enroll-selectYear").css("display", "none");
            // $("#enroll-selectGrade").css("display", "none");

        })



        function firstLoad() {
            
            enrollmentData = getEnrollmentData(state);
            ENR1 = enrollMap1();
            ENR1.drawMap(svgEnrollChart1, enrollmentData, state);

            ENR2 = enrollMap2();
            ENR2.drawMap(svgEnrollChart2, enrollmentData, state);

            ENR3 = enrollMap3();
            ENR3.drawMap(svgEnrollChart3, enrollmentData, state);

        }

        // first time loading
        firstLoad();

    </script>



</html>
